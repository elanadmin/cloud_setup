AWSTemplateFormatVersion: '2010-09-09'
Description: This template deploys Backup Policies required to manage backups at an organization level.

Parameters:
  pOrgbackupBronzeAccounts: 
    Description: A CSV list of the AWS accounts or OUs to attach backup policies. 
    Type: CommaDelimitedList
    Default: "ou-o8tt-7cu9j0xy,ou-o8tt-ph9mxujn,ou-o8tt-rn48gyv3"
  pOrgbackupSilverAccounts: 
    Description: A CSV list of the AWS accounts or OUs to attach backup policies. 
    Type: CommaDelimitedList
    Default: "717711644138,655538274560,721178831155,736200147754"
  pOrgbackupGoldAccounts: 
    Description: A CSV list of the AWS accounts or OUs to attach backup policies. 
    Type: CommaDelimitedList
    Default: "884506673723,005547792680,819521353958,605989421757,311927990054"
  pCrossAccountBackupRole:
    Description: This is the IAM role name for the cross-account backup role that carries out the backup activities.
    Type: String
    Default: AWSCrossAccountBackupRole
  pBackupSchedulerBronze:
    Description: The CRON or rate job to initiate backup jobs in backup policy bronze. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 22 ? * * *)"
  pBackupSchedulerHourlyBronze:
    Description: The CRON or rate job to initiate backup jobs in backup policy bronze. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 0/6 ? * * *)"
  pBackupSchedulerSilver:
    Description: The CRON or rate job to initiate backup jobs in backup policy silver. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 21 ? * * *)"
  pBackupSchedulerHourlySilver:
    Description: The CRON or rate job to initiate backup jobs in backup policy silver. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 0/6 ? * * *)"
  pBackupSchedulerGold:
    Description: The CRON or rate job to initiate backup jobs in backup policy gold. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 20 ? * * *)"
  pBackupSchedulerHourlyGold:
    Description: The CRON or rate job to initiate backup jobs in backup policy gold. For example, cron(0 0/1 ? * * *).
    Type: String
    Default: "cron(0 0/3 ? * * *)"
  pMemberAccountBackupVault:
    AllowedPattern: ^[a-zA-Z0-9\-\_\.]{1,50}$
    ConstraintDescription: The name of the member account Backup vaults. (Name is case sensitive). 
    Type: String
    Default: Infrastructure_AWS_Local_Backup_Vault
  pCentralBackupVaultArn:
    Type: String
    Description: This is the ARN of the centralized account backup vault.
    Default: "arn:aws:backup:us-east-1:169523143400:backup-vault:Infrastructure_AWS_Central_Backup_Vault"
  pBackupCommonTagKey:
    Type: String 
    Description: The tag key to automatically assign AWS Backup supported resources to a backup plan across the member accounts. 
    Default: 'Backup'
  pBackupCommonTagValue:
    Type: String 
    Description: The tag value to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Yes'
  pBackupRdsTagValue:
    Type: String 
    Description: The tag value to automatically assign AWS Backup RDS resources to a backup plan across the member accounts.
    Default: 'Rds'
  pBackupBronzeTagKey:
    Type: String 
    Description: The tag key to automatically assign AWS Backup supported resources to a backup plan across the member accounts. 
    Default: 'Backuplevel'
  pBackupBronzeTagValue:
    Type: String 
    Description: The tag value to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Bronze'
  pBackupSilverTagKey:
    Type: String 
    Description: The tag key to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Backuplevel'
  pBackupSilverTagValue:
    Type: String 
    Description: The tag value to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Silver'
  pBackupGoldTagKey:
    Type: String 
    Description: The tag key to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Backuplevel'
  pBackupGoldTagValue:
    Type: String 
    Description: The tag value to automatically assign AWS Backup supported resources to a backup plan across the member accounts.
    Default: 'Gold'
  pMgmtTagKey:
    Type: String 
    Description: This is the Mgmt tag key to assign to resources created by CloudFormation.
    Default: 'ManagedBy'
  pMgmtTagValue:
    Type: String 
    Description: This is the Mgmt tag value to assign to resources created by CloudFormation.
    Default: 'Cloud_Infrastructure_Team'
  pOwnerTagKey:
    Type: String 
    Description: This is the Owner tag key to assign to resources created by CloudFormation.
    Default: 'Owner'
  pOwnerTagValue:
    Type: String 
    Description: This is the Owner tag value to assign to resources created by CloudFormation.
    Default: 'Infrastructure'
  pStackBinaryURL:
    Description: The URL for the StackBinary Zip File
    Type: String    
    Default: 'https://awsstorageblogresources.s3.us-west-2.amazonaws.com/ioawssecbackupblog/OrgPolicyCustomResourceManager.zip'

Resources:
  rLocalCacheBucket:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true      

  CleanupLocalCacheBucketOnDelete:
    Type: Custom::CleanupBucket
    Properties:
      ServiceToken: !GetAtt rGlobalCfnCodeReplicatorLambda.Arn
      S3BucketToCleanup: !Ref rLocalCacheBucket  

  CopySolutionToLocalCacheBucket:
    Type: Custom::ReplicateSolutionBinaries
    Properties:
      ServiceToken: !GetAtt rGlobalCfnCodeReplicatorLambda.Arn
      SolutionDestinationBucket: !Ref rLocalCacheBucket
      SolutionURL: !Ref pStackBinaryURL

  rGlobalCfnCodeReplicatorLambda:
    Type: AWS::Lambda::Function
    Metadata:
        cfn_nag:
          rules_to_suppress:
            - id: W89
              reason: "NA"
            - id: W92
              reason: "NA"    
    Properties:
      Code:
        ZipFile: |-
          #!/usr/bin/env python
          # -*- coding: utf-8 -*-
          import json
          import boto3
          import urllib3
          import os
          import shutil
          from urllib.parse import urlparse
          physical_resource_id = 'GlobalCfnCodeReplicator'  
          def process_bucket_cleanup_request(bucket_name):
              print(f"process_bucket_cleanup_request starting for bucket_name : {bucket_name}")
              s3 = boto3.resource('s3')
              bucket_to_delete = s3.Bucket(bucket_name)
              response = bucket_to_delete.objects.all().delete()
              print(f"process_bucket_cleanup_request all object delete done. Response : {response}")
        
          def download_url(url, save_path):
            c = urllib3.PoolManager()
            with c.request('GET',url, preload_content=False) as resp, open(save_path, 'wb') as out_file:
                shutil.copyfileobj(resp, out_file)
            resp.release_conn()
            
          def lambda_handler(event, context):
            try:
                print(f'Handling event : {event}')
                request_type = event.get('RequestType')              
                solution_url = event['ResourceProperties'].get('SolutionURL')
                solution_bucket = event['ResourceProperties'].get('SolutionDestinationBucket')
                response_data = {
                    'RequestType': request_type,
                    'SolutionURL' : solution_url,
                    'SolutionDestinationBucket' : solution_bucket
                }
                if request_type == 'Create' or request_type == 'Update':
                    if solution_url:
                        print(f'downloading file from : {solution_url}')
                        a = urlparse(solution_url)
                        original_file_name = os.path.basename(a.path)
                        temp_file_name = '/tmp/'+original_file_name
                        download_url(solution_url,temp_file_name)
                        file_size = (os.stat(temp_file_name).st_size / 1024)
                        print(f'Downloaded report to File : {temp_file_name} , Size : {file_size}')
                        s3_client = boto3.client('s3')
                        print(f"uploading payload to : {solution_bucket} at {original_file_name}")
                        extraArgsForUpload = {'ACL':'bucket-owner-full-control', 'Tagging':'Source=StackBinaryURL'}
                        s3_client.upload_file(Filename=temp_file_name, Bucket=solution_bucket, Key=original_file_name,ExtraArgs=extraArgsForUpload)
                elif request_type == 'Delete':
                    solution_bucket = event['ResourceProperties'].get('S3BucketToCleanup')
                    if solution_bucket:
                        process_bucket_cleanup_request(solution_bucket)
                send(event, context, 'SUCCESS', response_data, physical_resource_id)
            except Exception as e:
                send(event, context, 'FAILED', response_data, physical_resource_id)
          def send(event, context, response_status, response_data, physical_resource_id, no_echo=False):
            http = urllib3.PoolManager()
            response_url = event['ResponseURL']
            json_response_body = json.dumps({
                'Status': response_status,
                'Reason': f'See the details in CloudWatch Log Stream: {context.log_stream_name}',
                'PhysicalResourceId': physical_resource_id,
                'StackId': event['StackId'],
                'RequestId': event['RequestId'],
                'LogicalResourceId': event['LogicalResourceId'],
                'NoEcho': no_echo,
                'Data': response_data
            }).encode('utf-8')
            headers = {
                'content-type': '',
                'content-length': str(len(json_response_body))
            }
            try:
                http.request('PUT', response_url,
                             body=json_response_body, headers=headers)
            except Exception as e:
                print(e)
      Description: Copy Solutions Binary to Local Cache Bucket
      Handler: index.lambda_handler
      Role : !GetAtt OrgPolicyCustomResourceManagerRole.Arn
      Runtime: python3.7
      Timeout: 300

  rOrgBackUpBronzePolicy:
    Type: Custom::OrgPolicy
    Properties:
      PolicyPrefix: org-backup-bronze-policy
      PolicyType: BACKUP_POLICY
      PolicyTargets : !Ref pOrgbackupBronzeAccounts
      PolicyDescription: >-
        BackupPolicy for Daily Backup as per the resource selection criteria
      PolicyContents: |-
            [
              {
                  "plans": {
                      "OrgDailyBackupPlan_Bronze": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgDailyBronzeBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Bronze"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "720"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "5"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Bronze"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Bronze"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "7"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "15"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Bronze"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Bronze"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                     "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_Common"
                                          ]
                                      }
                                  }
                              }
                          }
                      },
                      "OrgHourlyBackupPlan_Bronze": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgHourlyBronzeBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Hourly_Bronze"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "604800"
                                  },
                                  "enable_continuous_backup": {
                                      "@@assign": "true"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "5"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Bronze"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Bronze"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "7"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "15"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Bronze"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Bronze"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_RDS"
                                          ]
                                      }
                                  }
                              }
                          }
                      }
                  }
              }
            ]
      Variables:
          - BACKUP_ROLE: !Ref "pCrossAccountBackupRole"
          - VAULT_NAME: !Ref pMemberAccountBackupVault
          - TAG_KEY_Common : !Ref "pBackupCommonTagKey"
          - TAG_VALUE_Common : !Ref "pBackupCommonTagValue"
          - TAG_VALUE_RDS : !Ref "pBackupRdsTagValue"
          - TAG_KEY_Bronze : !Ref "pBackupBronzeTagKey"
          - TAG_VALUE_Bronze : !Ref "pBackupBronzeTagValue"
          - TAG_KEY_Mgmt : !Ref "pMgmtTagKey"
          - TAG_VALUE_Mgmt : !Ref "pMgmtTagValue"
          - TAG_KEY_Owner: !Ref "pOwnerTagKey"
          - TAG_VALUE_Owner: !Ref "pOwnerTagValue"
          - SCHEDULE_EXPRESSION_Bronze : !Ref "pBackupSchedulerBronze"
          - SCHEDULE_EXPRESSION_Hourly_Bronze : !Ref "pBackupSchedulerHourlyBronze"
          - CENTRAL_VAULT_ARN : !Ref "pCentralBackupVaultArn"
      ServiceToken: !GetAtt OrgPolicyCustomResourceManager.Arn

  rOrgBackUpSilverPolicy:
    Type: Custom::OrgPolicy
    Properties:
      PolicyPrefix: org-backup-silver-policy
      PolicyType: BACKUP_POLICY
      PolicyTargets : !Ref pOrgbackupSilverAccounts
      PolicyDescription: >-
        BackupPolicy for Daily Backup as per the resource selection criteria
      PolicyContents: |-
            [
              {
                  "plans": {
                      "OrgDailyBackupPlan_Silver": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgDailySilverBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Silver"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "720"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "14"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Silver"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Silver"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "15"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "30"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Silver"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Silver"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Silver"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_Silver"
                                          ]
                                      }
                                  },
                                  "OrgDailyBackupSelection2": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_Common"
                                          ]
                                      }
                                  }
                              }
                          }
                      },
                      "OrgHourlyBackupPlan_Silver": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgHourlySilverBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Hourly_Silver"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "604800"
                                  },
                                  "enable_continuous_backup": {
                                      "@@assign": "true"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "14"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Silver"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Silver"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "15"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "30"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Silver"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Silver"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_RDS"
                                          ]
                                      }
                                  }
                              }
                          }
                      }
                  }
              }
            ]
      Variables:
          - BACKUP_ROLE: !Ref "pCrossAccountBackupRole"
          - VAULT_NAME: !Ref pMemberAccountBackupVault
          - TAG_KEY_Common : !Ref "pBackupCommonTagKey"
          - TAG_VALUE_Common : !Ref "pBackupCommonTagValue"
          - TAG_VALUE_RDS : !Ref "pBackupRdsTagValue"
          - TAG_KEY_Silver : !Ref "pBackupSilverTagKey"
          - TAG_VALUE_Silver : !Ref "pBackupSilverTagValue"
          - TAG_KEY_Mgmt : !Ref "pMgmtTagKey"
          - TAG_VALUE_Mgmt : !Ref "pMgmtTagValue"
          - TAG_KEY_Owner: !Ref "pOwnerTagKey"
          - TAG_VALUE_Owner: !Ref "pOwnerTagValue"
          - SCHEDULE_EXPRESSION_Silver : !Ref "pBackupSchedulerSilver"
          - SCHEDULE_EXPRESSION_Hourly_Silver : !Ref "pBackupSchedulerHourlySilver"
          - CENTRAL_VAULT_ARN : !Ref "pCentralBackupVaultArn"
      ServiceToken: !GetAtt OrgPolicyCustomResourceManager.Arn

  rOrgBackUpGoldPolicy:
    Type: Custom::OrgPolicy
    Properties:
      PolicyPrefix: org-backup-gold-policy
      PolicyType: BACKUP_POLICY
      PolicyTargets : !Ref pOrgbackupGoldAccounts
      PolicyDescription: >-
        BackupPolicy for Daily Backup as per the resource selection criteria
      PolicyContents: |-
            [
              {
                  "plans": {
                      "OrgDailyBackupPlan_Gold": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgDailyGoldBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Gold"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "720"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "31"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Gold"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Gold"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "35"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "60"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Gold"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Gold"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_Common"
                                          ]
                                      }
                                  }
                              }
                          }
                      },
                      "OrgHourlyBackupPlan_Gold": {
                          "regions": {
                            "@@append":[ "us-east-1" ] },
                          "rules": {
                              "OrgHourlyGoldBackupRule": {
                                  "schedule_expression": {
                                      "@@assign": "SCHEDULE_EXPRESSION_Hourly_Gold"
                                  },
                                  "start_backup_window_minutes": {
                                      "@@assign": "60"
                                  },
                                  "complete_backup_window_minutes": {
                                      "@@assign": "604800"
                                  },
                                  "enable_continuous_backup": {
                                      "@@assign": "true"
                                  },
                                  "lifecycle": {
                                      "delete_after_days": {
                                          "@@assign": "31"
                                      }
                                  },
                                  "target_backup_vault_name": {
                                      "@@assign": "VAULT_NAME"
                                  },
                                  "recovery_point_tags": {
                                      "managedby": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Mgmt"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Mgmt"
                                          }
                                      },
                                      "backuplevel": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Gold"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Gold"
                                          }
                                      },
                                      "owner": {
                                          "tag_key": {
                                              "@@assign": "TAG_KEY_Owner"
                                          },
                                          "tag_value": {
                                              "@@assign": "TAG_VALUE_Owner"
                                          }
                                      }
                                  },
                                  "copy_actions": {
                                    "CENTRAL_VAULT_ARN": {
                                      "target_backup_vault_arn": {
                                        "@@assign": "CENTRAL_VAULT_ARN"
                                      },
                                      "lifecycle": {
                                        "move_to_cold_storage_after_days": {
                                          "@@assign": "35"
                                        },
                                        "delete_after_days": {
                                          "@@assign": "60"
                                        }
                                      }
                                    }
                                  }
                              }                            
                          },
                          "advanced_backup_settings": {
                              "ec2": {
                                  "windows_vss": {"@@assign": "enabled"}
                              }
                          },
                          "backup_plan_tags": {
                              "managedby": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Mgmt"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Mgmt"
                                  }
                              },
                              "backuplevel": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Gold"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Gold"
                                  }
                              },
                              "owner": {
                                  "tag_key": {
                                      "@@assign": "TAG_KEY_Owner"
                                  },
                                  "tag_value": {
                                      "@@assign": "TAG_VALUE_Owner"
                                  }
                              }
                          },
                          "selections": {
                              "tags": {
                                  "OrgDailyBackupSelection1": {
                                      "iam_role_arn": {
                                          "@@assign": "arn:aws:iam::$account:role/BACKUP_ROLE"
                                      },
                                      "tag_key": {
                                          "@@assign": "TAG_KEY_Common"
                                      },
                                      "tag_value": {
                                          "@@assign": [
                                              "TAG_VALUE_RDS"
                                          ]
                                      }
                                  }
                              }
                          }
                      }
                  }
              }
            ]
      Variables:
          - BACKUP_ROLE: !Ref "pCrossAccountBackupRole"
          - VAULT_NAME: !Ref pMemberAccountBackupVault
          - TAG_KEY_Common : !Ref "pBackupCommonTagKey"
          - TAG_VALUE_Common : !Ref "pBackupCommonTagValue"
          - TAG_VALUE_RDS : !Ref "pBackupRdsTagValue"
          - TAG_KEY_Gold : !Ref "pBackupGoldTagKey"
          - TAG_VALUE_Gold : !Ref "pBackupGoldTagValue"
          - TAG_KEY_Owner: !Ref "pOwnerTagKey"
          - TAG_VALUE_Owner: !Ref "pOwnerTagValue"
          - TAG_KEY_Mgmt : !Ref "pMgmtTagKey"
          - TAG_VALUE_Mgmt : !Ref "pMgmtTagValue"
          - SCHEDULE_EXPRESSION_Gold : !Ref "pBackupSchedulerGold"
          - SCHEDULE_EXPRESSION_Hourly_Gold : !Ref "pBackupSchedulerHourlyGold"
          - CENTRAL_VAULT_ARN : !Ref "pCentralBackupVaultArn"
      ServiceToken: !GetAtt OrgPolicyCustomResourceManager.Arn
      
  OrgPolicyCustomResourceManager:
    Type: AWS::Lambda::Function
    DependsOn: CopySolutionToLocalCacheBucket
    Properties:
      FunctionName: OrgPolicyCustomResourceManager
      Description: Lambda function to deploy CloudFormation custom resources
                   to AWS Organizations.
      Handler: OrgPolicyCustomResourceManager.lambda_handler
      Code:
        S3Bucket: !Ref rLocalCacheBucket
        S3Key: OrgPolicyCustomResourceManager.zip
      Role: !GetAtt OrgPolicyCustomResourceManagerRole.Arn
      Runtime: python3.8
      MemorySize: 256
      Timeout: 300
      Tags:
        - Key: !Ref pMgmtTagKey
          Value: !Ref pMgmtTagValue
        - Key: !Ref pOwnerTagKey
          Value: !Ref pOwnerTagValue

  OrgPolicyCustomResourceManagerRole:
    Type: 'AWS::IAM::Role'
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: IAM role should not allow * resource on its permissions policy
          - id: F3
            reason: IAM role should not allow * resource on its permissions policy
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'lambda.amazonaws.com'
          Action:
          - 'sts:AssumeRole'
      Path: '/'
      ManagedPolicyArns:
      - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
      - PolicyName: AssumeOrgRole
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRole
            Resource: '*'
      - PolicyName: OrgPermissions
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
              - organizations:CreatePolicy
              - organizations:DeletePolicy
              - organizations:AttachPolicy
              - organizations:DetachPolicy
              - organizations:ListPolicies
              - organizations:UpdatePolicy
              - organizations:DescribePolicy
              - organizations:ListTargetsForPolicy              
            Resource: '*'
      - PolicyName: S3Permissions
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
              - s3:*
            Resource: 
              !Sub arn:aws:s3:::${rLocalCacheBucket}/*